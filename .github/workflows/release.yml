name: Release

on:
  workflow_dispatch: # Allows manual trigger from Actions tab
  push:
    tags: [ 'v*' ]
#  workflow_run:
#    workflows: [ "CI (build, lint, test)" ]
#    types: [ completed ]
#    branches: [ main ]

jobs:
  bump_version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: false

  goreleaser:
    needs:
      - bump_version
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: v2
          args: release --clean --config .github/goreleaser.yaml
        env:
          GITHUB_TOKEN:          ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          MACOS_SIGN_P12:        ${{ secrets.MACOS_SIGN_P12 }}
          MACOS_SIGN_PASSWORD:   ${{ secrets.MACOS_SIGN_PASSWORD }}
          NOTARIZE_ISSUER_ID:    ${{ secrets.NOTARIZE_ISSUER_ID }}
          NOTARIZE_KEY_ID:       ${{ secrets.NOTARIZE_KEY_ID }}
          NOTARIZE_KEY:          ${{ secrets.NOTARIZE_KEY }}

  deploy-server:
    name: Deploy to Cloud Run
    needs:
      - goreleaser
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy to Cloud Run
        uses: ./.github/actions/deploy-to-cloud-run
        with:
          gcloud_project_id: ${{ vars.GCLOUD_PROJECT_ID || 'ingitdb' }}
          gcloud_region: ${{ vars.GCLOUD_REGION || 'europe-west3' }}
          service_name: ${{ vars.SERVICE_NAME || 'ingitdb-server' }}
          ingitdb_github_oauth_client_id: ${{ vars.INGITDB_GITHUB_OAUTH_CLIENT_ID }}
          ingitdb_github_oauth_callback_url: ${{ vars.INGITDB_GITHUB_OAUTH_CALLBACK_URL }}
          ingitdb_auth_cookie_domain: ${{ vars.INGITDB_AUTH_COOKIE_DOMAIN }}
          ingitdb_auth_api_base_url: ${{ vars.INGITDB_AUTH_API_BASE_URL }}
          ingitdb_auth_cookie_name: ${{ vars.INGITDB_AUTH_COOKIE_NAME || 'ingitdb_session' }}
          ingitdb_auth_cookie_secure: ${{ vars.INGITDB_AUTH_COOKIE_SECURE || 'true' }}
          gcp_oauth_client_secret_name: ${{ vars.GCP_OAUTH_CLIENT_SECRET_NAME }}
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER || 'projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb' }}

  deploy-website:
    name: Deploy Website
    needs:
      - goreleaser
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy website
        uses: ./.github/actions/deploy-website
        with:
          gcloud_project_id: ${{ vars.GCLOUD_PROJECT_ID || 'ingitdb' }}
          firebase_target: ${{ vars.FIREBASE_TARGET || 'ingitdb-com' }}
          firebase_config_path: server/firebase.json
          workload_identity_provider: ${{ vars.WORKLOAD_IDENTITY_PROVIDER || 'projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb' }}
          node_version: "20"
