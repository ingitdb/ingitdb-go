name: Release

on:
  workflow_dispatch: # Allows manual trigger from Actions tab
  push:
    tags: [ 'v*' ]
#  workflow_run:
#    workflows: [ "CI (build, lint, test)" ]
#    types: [ completed ]
#    branches: [ main ]

jobs:
  bump_version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Bump version and push tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          default_bump: false

  goreleaser:
    needs:
      - bump_version
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - uses: actions/setup-go@v6
        with:
          go-version: stable

      - uses: goreleaser/goreleaser-action@v6
        with:
          version: v2
          args: release --clean --config .github/goreleaser.yaml
        env:
          GITHUB_TOKEN:          ${{ secrets.INGITDB_GORELEASER_GITHUB_TOKEN }}
          MACOS_SIGN_P12:        ${{ secrets.MACOS_SIGN_P12 }}
          MACOS_SIGN_PASSWORD:   ${{ secrets.MACOS_SIGN_PASSWORD }}
          NOTARIZE_ISSUER_ID:    ${{ secrets.NOTARIZE_ISSUER_ID }}
          NOTARIZE_KEY_ID:       ${{ secrets.NOTARIZE_KEY_ID }}
          NOTARIZE_KEY:          ${{ secrets.NOTARIZE_KEY }}

  deploy-server:
    name: Deploy to Cloud Run
    needs:
      - goreleaser
    runs-on: ubuntu-latest

    env:
      GCLOUD_PROJECT_ID: ingitdb
      GCLOUD_REGION: europe-west3
      SERVICE_NAME: ingitdb-server
      INGITDB_GITHUB_OAUTH_CLIENT_ID: ${{ vars.INGITDB_GITHUB_OAUTH_CLIENT_ID }}
      INGITDB_GITHUB_OAUTH_CALLBACK_URL: ${{ vars.INGITDB_GITHUB_OAUTH_CALLBACK_URL }}
      INGITDB_AUTH_COOKIE_DOMAIN: ${{ vars.INGITDB_AUTH_COOKIE_DOMAIN }}
      INGITDB_AUTH_API_BASE_URL: ${{ vars.INGITDB_AUTH_API_BASE_URL }}
      INGITDB_AUTH_COOKIE_NAME: ${{ vars.INGITDB_AUTH_COOKIE_NAME }}
      INGITDB_AUTH_COOKIE_SECURE: ${{ vars.INGITDB_AUTH_COOKIE_SECURE }}
      GCP_OAUTH_CLIENT_SECRET_NAME: ${{ vars.GCP_OAUTH_CLIENT_SECRET_NAME }}

    permissions:
      contents: 'read'
      id-token: 'write'
      packages: 'read'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy to Cloud Run
        uses: ./.github/actions/deploy-to-cloud-run
        with:
          gcloud_project_id: ${{ env.GCLOUD_PROJECT_ID }}
          gcloud_region: ${{ env.GCLOUD_REGION }}
          service_name: ${{ env.SERVICE_NAME }}
          ingitdb_github_oauth_client_id: ${{ env.INGITDB_GITHUB_OAUTH_CLIENT_ID }}
          ingitdb_github_oauth_callback_url: ${{ env.INGITDB_GITHUB_OAUTH_CALLBACK_URL }}
          ingitdb_auth_cookie_domain: ${{ env.INGITDB_AUTH_COOKIE_DOMAIN }}
          ingitdb_auth_api_base_url: ${{ env.INGITDB_AUTH_API_BASE_URL }}
          ingitdb_auth_cookie_name: ${{ env.INGITDB_AUTH_COOKIE_NAME }}
          ingitdb_auth_cookie_secure: ${{ env.INGITDB_AUTH_COOKIE_SECURE }}
          gcp_oauth_client_secret_name: ${{ env.GCP_OAUTH_CLIENT_SECRET_NAME }}
          workload_identity_provider: projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb

  deploy-website:
    name: Deploy Website
    needs:
      - goreleaser
    runs-on: ubuntu-latest

    env:
      GCLOUD_PROJECT_ID: ingitdb
      FIREBASE_TARGET: ingitdb-com

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - uses: actions/checkout@v6

      - name: Deploy website
        uses: ./.github/actions/deploy-website
        with:
          gcloud_project_id: ${{ env.GCLOUD_PROJECT_ID }}
          firebase_target: ${{ env.FIREBASE_TARGET }}
          firebase_config_path: server/firebase.json
          workload_identity_provider: projects/152447355531/locations/global/workloadIdentityPools/github/providers/ingitdb
          node_version: "20"
